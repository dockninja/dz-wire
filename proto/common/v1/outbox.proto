// outbox.proto
syntax = "proto3";

package common.v1;

import "google/protobuf/duration.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/dockninja/dz-wire/gen/go/common/v1;pbcommon";

enum OutboxStatus {
  OUTBOX_STATUS_UNSPECIFIED = 0;
  OUTBOX_STATUS_PENDING = 1;
  OUTBOX_STATUS_PROCESSING = 2;
  OUTBOX_STATUS_SENT = 3;
  OUTBOX_STATUS_FAILED = 4;
}

message OutboxEnvelope {
  // Caller-generated id (not the DB row id)
  string event_id = 1;

  // e.g. "domain.changed"
  string type = 2;

  uint32 version = 3;
  google.protobuf.Timestamp occurred_at = 4;

  string correlation_id = 5;
  string trace_id = 6;

  google.protobuf.Struct data = 7;
  google.protobuf.Struct meta = 8;
}

message OutboxRecord {
  string id = 1; // UUID (row id)
  string topic = 2;
  string dedup_key = 3; // empty => NULL
  OutboxEnvelope payload = 4;

  OutboxStatus status = 5;
  uint32 attempts = 6;

  google.protobuf.Timestamp available_at = 7;
  google.protobuf.Timestamp locked_at = 8; // unset => NULL
  string locked_by = 9; // empty => NULL

  string last_error = 10; // empty => NULL

  google.protobuf.Timestamp created_at = 11;
  google.protobuf.Timestamp sent_at = 12; // unset => NULL
}

message OutboxAckParams {
  string id = 1; // UUID (row id)
  google.protobuf.Timestamp at = 2; // unset => now()
}

message OutboxEnqueueParams {
  string topic = 1;
  string dedup_key = 2; // empty => NULL
  OutboxEnvelope payload = 3;
  google.protobuf.Timestamp available_at = 4; // unset => now()
}

message OutboxEnqueueResult {
  string id = 1; // UUID, empty if dedup prevented insert
  bool created = 2;
}

message OutboxDequeueParams {
  string topic = 1; // empty => any
  uint32 limit = 2;
  string worker_id = 3;
  google.protobuf.Timestamp now = 4; // unset => now()
  google.protobuf.Duration lock_for = 5;
}

message OutboxFailParams {
  string id = 1; // UUID (row id)
  google.protobuf.Timestamp at = 2; // unset => now()
  string error = 3;

  // unset => mark failed, set => retry by re-queueing at retry_at
  google.protobuf.Timestamp retry_at = 4;
}
